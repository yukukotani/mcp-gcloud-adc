# 要件ドキュメント

## 概要

Google Cloud Run上でIAM認証付きでホストされているStreamable HTTP方式のMCPサーバーに対して、ローカルのApplication Default Credentials (ADC)を使用して認証を行い、接続するプロキシツールを開発します。このプロキシ自体はstdio方式のMCPサーバーとして動作し、MCPクライアントからの標準入出力を受け取り、Cloud Run上のMCPサーバーにHTTPリクエストとして転送します。

## 要件

### 要件1: CLIツールの基本動作

**ユーザーストーリー:** 開発者として、コマンドラインからプロキシを起動し、Cloud Run上のMCPサーバーに接続したい。これにより、ローカル環境からクラウド上のMCPサーバーを利用できる。

#### 受入基準

1. WHEN ユーザーがCLIコマンドを実行 THEN システムは stdio方式のMCPサーバーとして起動する
2. WHEN Cloud RunのURLが引数として提供される THEN システムは そのURLを接続先として保存する
3. IF 必要な引数が不足している THEN システムは エラーメッセージを表示して終了する
4. WHEN プロキシが起動完了 THEN システムは 標準入出力でMCPプロトコルのメッセージを受信可能な状態になる

### 要件2: Google Cloud認証

**ユーザーストーリー:** 開発者として、ローカルのApplication Default Credentialsを使用してCloud Run上のIAM認証付きサービスに自動的に認証したい。これにより、追加の認証設定なしでセキュアな接続が可能になる。

#### 受入基準

1. WHEN プロキシが起動 THEN システムは Application Default Credentialsを自動的に検出する
2. IF ADCが利用可能 THEN システムは IDトークンを取得する
3. IF ADCが見つからない THEN システムは エラーメッセージを表示して終了する
4. WHEN Cloud Runへのリクエスト送信時 THEN システムは AuthorizationヘッダーにIDトークンを含める
5. IF IDトークンの有効期限が切れた THEN システムは 自動的にトークンを更新する

### 要件3: stdio方式MCPサーバーとしての動作

**ユーザーストーリー:** MCPクライアントとして、標準的なstdio方式のMCPサーバーと同じようにプロキシと通信したい。これにより、既存のMCPクライアントツールとの互換性が保たれる。

#### 受入基準

1. WHEN MCPクライアントが標準入力にJSON-RPCメッセージを送信 THEN システムは そのメッセージを受信して処理する
2. WHEN MCPクライアントからinitializeリクエストを受信 THEN システムは Cloud Runサーバーに転送し、レスポンスをクライアントに返す
3. WHEN MCPクライアントからtool/listリクエストを受信 THEN システムは Cloud Runサーバーに転送し、利用可能なツール一覧を返す
4. WHEN MCPクライアントからtool/callリクエストを受信 THEN システムは Cloud Runサーバーに転送し、実行結果を返す
5. WHEN Cloud Runサーバーからレスポンスを受信 THEN システムは 標準出力にJSON-RPCレスポンスを送信する

### 要件4: Streamable HTTP方式での通信

**ユーザーストーリー:** プロキシとして、Cloud Run上のStreamable HTTP方式のMCPサーバーと正しく通信したい。これにより、HTTPベースの効率的な通信が可能になる。

#### 受入基準

1. WHEN MCPメッセージを転送する必要がある THEN システムは HTTPSでCloud RunエンドポイントにPOSTリクエストを送信する
2. WHEN HTTPリクエストを送信 THEN システムは Content-Typeヘッダーを"application/json"に設定する
3. WHEN Cloud Runサーバーがストリーミングレスポンスを返す THEN システムは レスポンスをストリーミングで受信する
4. IF HTTPリクエストが失敗 THEN システムは エラーをMCPエラーレスポンスとしてクライアントに返す
5. WHEN 複数のレスポンスがストリーミングで返される THEN システムは 各レスポンスを順次クライアントに転送する

### 要件5: エラーハンドリング

**ユーザーストーリー:** 開発者として、接続エラーや認証エラーが発生した場合に適切なエラーメッセージを受け取りたい。これにより、問題の診断と解決が容易になる。

#### 受入基準

1. IF Cloud Runサーバーへの接続が失敗 THEN システムは 接続エラーの詳細をログに出力する
2. IF 認証が失敗（401/403エラー） THEN システムは 認証エラーメッセージをクライアントに返す
3. IF Cloud RunサーバーがHTTPエラーを返す THEN システムは HTTPステータスコードとエラー内容をMCPエラーとして返す
4. IF ネットワークタイムアウトが発生 THEN システムは タイムアウトエラーをクライアントに返す
5. WHEN 予期しないエラーが発生 THEN システムは エラーログを出力し、MCPエラーレスポンスを返す

### 要件6: 設定とカスタマイズ

**ユーザーストーリー:** 開発者として、プロキシの動作を環境変数やコマンドライン引数でカスタマイズしたい。これにより、異なる環境での利用が容易になる。

#### 受入基準

1. WHEN --urlフラグが指定される THEN システムは そのURLをCloud Runエンドポイントとして使用する
2. IF --timeoutフラグが指定される THEN システムは HTTPリクエストのタイムアウト値を設定する
3. WHEN --verboseフラグが指定される THEN システムは 詳細なデバッグログを出力する
4. IF 環境変数GOOGLE_APPLICATION_CREDENTIALSが設定されている THEN システムは そのクレデンシャルファイルを使用する
5. WHEN --helpフラグが指定される THEN システムは 使用方法とオプションの説明を表示する