# 実装計画

## プロジェクトセットアップとコア構造

- [ ] 1. プロジェクトの初期セットアップ
  - package.jsonに必要な依存関係を追加（@modelcontextprotocol/sdk、gunshi、google-auth-library）
  - TypeScript設定の確認と調整
  - ディレクトリ構造の作成（presentation、usecase、libs）
  - _要件: 1.1, 6.5_

## 基本的なCLI実装

- [ ] 2. gunshiを使用したCLIエントリーポイントの実装
  - [ ] 2.1 CLIコマンド定義の作成（src/presentation/cli.ts）
    - gunshiのdefine関数を使用した型安全なコマンド定義
    - url、timeout、verboseオプションの実装
    - バリデーション（HTTPS URLチェック）の追加
    - _要件: 1.1, 1.2, 1.3_
  
  - [ ] 2.2 CLIエントリーポイントのテスト作成
    - 引数パースのテスト
    - バリデーションエラーのテスト
    - _要件: 1.3_

## Google Cloud認証の実装

- [ ] 3. Google Cloud認証クライアントの実装
  - [ ] 3.1 認証クライアントインターフェースの定義（src/libs/auth/types.ts）
    - AuthClient型の定義
    - GetIdTokenResult型の定義
    - AuthError型の定義
    - _要件: 2.1_
  
  - [ ] 3.2 Google Auth実装の作成（src/libs/auth/google-auth.ts）
    - google-auth-libraryを使用したADC検出
    - IDトークンの取得実装
    - トークンキャッシュとリフレッシュ機能
    - _要件: 2.2, 2.3, 2.4, 2.5_
  
  - [ ] 3.3 認証クライアントのテスト作成
    - ADC検出のテスト
    - トークン取得のテスト
    - エラーハンドリングのテスト
    - _要件: 2.3, 5.2_

## HTTPクライアントの実装

- [ ] 4. HTTPクライアントの実装
  - [ ] 4.1 HTTPクライアントインターフェースの定義（src/libs/http/types.ts）
    - HttpClient型の定義
    - HttpRequestConfig型の定義
    - HttpResponse型とHttpError型の定義
    - _要件: 4.1_
  
  - [ ] 4.2 HTTPクライアント実装の作成（src/libs/http/http-client.ts）
    - Node.js fetchを使用したPOSTリクエスト実装
    - タイムアウト処理
    - ストリーミングレスポンス対応
    - _要件: 4.2, 4.3, 4.5_
  
  - [ ] 4.3 HTTPクライアントのテスト作成
    - 正常なリクエスト/レスポンスのテスト
    - タイムアウトのテスト
    - エラーハンドリングのテスト
    - _要件: 4.4, 5.1, 5.4_

## MCPプロキシロジックの実装

- [ ] 5. MCPプロキシハンドラーの実装
  - [ ] 5.1 プロキシインターフェースの定義（src/usecase/mcp-proxy/types.ts）
    - McpProxy型の定義
    - ProxyConfig型の定義
    - _要件: 3.1, 4.1_
  
  - [ ] 5.2 プロキシハンドラー実装の作成（src/usecase/mcp-proxy/handler.ts）
    - リクエスト転送ロジック
    - 認証ヘッダーの付与
    - レスポンス処理
    - _要件: 3.2, 3.3, 3.4, 3.5, 4.1_
  
  - [ ] 5.3 プロキシハンドラーのテスト作成
    - 各種MCPメソッドの転送テスト
    - エラーハンドリングのテスト
    - _要件: 3.2, 3.3, 3.4, 5.3_

## MCP SDKサーバーの実装

- [ ] 6. @modelcontextprotocol/sdk Serverの実装
  - [ ] 6.1 MCPサーバーセットアップ関数の作成（src/libs/mcp/server-setup.ts）
    - Server インスタンスの初期化
    - StdioServerTransportの設定
    - リクエストハンドラーの登録
    - _要件: 3.1, 3.5_
  
  - [ ] 6.2 リクエストハンドラーの実装（src/libs/mcp/request-handlers.ts）
    - initializeハンドラー
    - tools/listハンドラー
    - tools/callハンドラー
    - resources関連ハンドラー
    - _要件: 3.2, 3.3, 3.4_
  
  - [ ] 6.3 MCPサーバーのテスト作成
    - 各ハンドラーのテスト
    - stdio通信のテスト
    - _要件: 3.1, 3.5_

## エラーハンドリングとロギング

- [ ] 7. エラーハンドリングの実装
  - [ ] 7.1 統一エラーハンドリング機能の作成（src/libs/error/handler.ts）
    - McpError生成ユーティリティ
    - エラー分類と適切なエラーコード割り当て
    - ログ出力機能
    - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ] 7.2 ロギングユーティリティの作成（src/libs/logging/logger.ts）
    - verboseモード対応
    - 構造化ログ出力
    - _要件: 6.3, 5.1_
  
  - [ ] 7.3 エラーハンドリングのテスト作成
    - 各種エラーケースのテスト
    - ログ出力のテスト
    - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

## メインアプリケーションの統合

- [ ] 8. メインアプリケーションの実装
  - [ ] 8.1 アプリケーション起動関数の作成（src/index.ts）
    - CLIコマンドの実行
    - 依存関係の初期化
    - プロキシサーバーの起動
    - _要件: 1.1, 1.4_
  
  - [ ] 8.2 設定管理の実装（src/libs/config/manager.ts）
    - 環境変数の読み込み
    - コマンドライン引数との統合
    - _要件: 6.1, 6.2, 6.4_
  
  - [ ] 8.3 グレースフルシャットダウンの実装
    - シグナルハンドリング
    - リソースのクリーンアップ
    - _要件: 1.4_

## 統合テストとドキュメント

- [ ] 9. 統合テストの作成
  - [ ] 9.1 End-to-Endテストの作成（src/test/e2e/proxy.test.ts）
    - stdio入力からHTTP転送までの完全フロー
    - 認証フローを含むテスト
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [ ] 9.2 ストリーミングテストの作成
    - 複数チャンクのレスポンス処理
    - 中断されたストリームのテスト
    - _要件: 4.3, 4.5_
  
  - [ ] 9.3 エラーシナリオのテスト
    - 認証失敗のテスト
    - ネットワーク障害のテスト
    - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

## ビルドとパッケージング

- [ ] 10. ビルドとパッケージングの設定
  - [ ] 10.1 ビルドスクリプトの作成
    - TypeScriptコンパイル設定
    - 実行可能ファイルの生成設定
    - _要件: 1.1_
  
  - [ ] 10.2 npm パッケージの設定
    - package.jsonの最終調整
    - bin フィールドの設定
    - _要件: 1.1_
  
  - [ ] 10.3 READMEとドキュメントの作成
    - 使用方法の記載
    - 設定オプションの説明
    - トラブルシューティングガイド
    - _要件: 6.5_